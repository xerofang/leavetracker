<%- include('../layouts/main', { body: `
<div class="row justify-content-center">
  <div class="col-lg-10">
    <div class="card shadow">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-person-plus"></i> Apply Leave on Behalf</h5>
        <small>Create a leave request for an employee (requires approval)</small>
      </div>
      <div class="card-body p-4">
        <form method="POST" action="/admin/apply-behalf" id="leaveForm">
          <div class="row">
            <!-- Left Column - Form Fields -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="employee_id" class="form-label">Select Employee <span class="text-danger">*</span></label>
                <select class="form-select" id="employee_id" name="employee_id" required>
                  <option value="">Choose employee...</option>
                  ${employees.map(e => `<option value="${e.id}">${e.first_name} ${e.last_name} (${e.email})</option>`).join('')}
                </select>
              </div>

              <div class="mb-3">
                <label for="leave_type_id" class="form-label">Leave Type <span class="text-danger">*</span></label>
                <select class="form-select" id="leave_type_id" name="leave_type_id" required>
                  <option value="">Select leave type</option>
                  ${leaveTypes.map(lt => `<option value="${lt.id}">${lt.name}</option>`).join('')}
                </select>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="start_date" class="form-label">Start Date <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="start_date" name="start_date" required>
                </div>
                <div class="col-md-6">
                  <label for="end_date" class="form-label">End Date <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="end_date" name="end_date" required>
                </div>
              </div>

              <div class="mb-4">
                <label for="reason" class="form-label">Reason</label>
                <textarea class="form-control" id="reason" name="reason" rows="3" placeholder="Enter reason for leave"></textarea>
              </div>
            </div>

            <!-- Right Column - Balance Preview -->
            <div class="col-md-6">
              <div class="card bg-light">
                <div class="card-header">
                  <strong><i class="bi bi-calculator"></i> Balance Preview</strong>
                </div>
                <div class="card-body">
                  <div id="previewLoading" class="text-center text-muted d-none">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    Calculating...
                  </div>

                  <div id="previewPlaceholder" class="text-muted">
                    <i class="bi bi-info-circle"></i> Select employee, leave type, and dates to see balance
                  </div>

                  <div id="simpleBalance" class="d-none">
                    <div class="mb-2">
                      <strong>Working Days:</strong> <span id="workingDays" class="badge bg-primary">0</span>
                    </div>
                    <div class="mb-2">
                      <strong>Available Balance:</strong> <span id="availableBalance" class="badge bg-success">0</span>
                    </div>
                    <div id="sufficientMsg" class="alert alert-success py-2 d-none">
                      <i class="bi bi-check-circle"></i> Sufficient balance available
                    </div>
                  </div>

                  <div id="smartConsumption" class="d-none">
                    <div class="alert alert-info py-2">
                      <i class="bi bi-info-circle"></i> <strong>Smart Consumption:</strong> Balance insufficient for selected type. Days will be consumed from multiple types.
                    </div>

                    <table class="table table-sm table-bordered">
                      <thead class="table-light">
                        <tr>
                          <th>Leave Type</th>
                          <th class="text-center">Available</th>
                          <th class="text-center">To Use</th>
                        </tr>
                      </thead>
                      <tbody id="breakdownTable">
                      </tbody>
                    </table>

                    <!-- Unpaid Warning -->
                    <div id="unpaidWarning" class="alert alert-danger d-none">
                      <i class="bi bi-exclamation-circle"></i>
                      <strong>Unpaid Leave:</strong> <span id="unpaidDaysDisplay">0</span> days will be unpaid.
                    </div>

                    <!-- Smart Consumption Confirmation -->
                    <div class="form-check mt-3">
                      <input class="form-check-input" type="checkbox" id="confirmSmart">
                      <label class="form-check-label" for="confirmSmart">
                        I confirm this multi-type balance consumption
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Hidden fields -->
          <input type="hidden" id="confirmed_breakdown" name="confirmed_breakdown" value="">

          <hr class="my-4">

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="/admin/requests" class="btn btn-outline-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              <i class="bi bi-send"></i> Submit Request
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('employee_id').addEventListener('change', previewConsumption);
document.getElementById('leave_type_id').addEventListener('change', previewConsumption);
document.getElementById('start_date').addEventListener('change', previewConsumption);
document.getElementById('end_date').addEventListener('change', previewConsumption);
document.getElementById('confirmSmart').addEventListener('change', updateSubmitButton);

let currentMode = 'simple'; // 'simple' or 'smart'

async function previewConsumption() {
  const employeeId = document.getElementById('employee_id').value;
  const leaveTypeId = document.getElementById('leave_type_id').value;
  const startDate = document.getElementById('start_date').value;
  const endDate = document.getElementById('end_date').value;

  // Reset
  document.getElementById('confirmSmart').checked = false;
  document.getElementById('confirmed_breakdown').value = '';
  currentMode = 'simple';

  if (!employeeId || !leaveTypeId || !startDate || !endDate) {
    showPlaceholder();
    return;
  }

  if (new Date(endDate) < new Date(startDate)) {
    document.getElementById('previewPlaceholder').innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> End date must be after start date</span>';
    document.getElementById('previewPlaceholder').classList.remove('d-none');
    document.getElementById('simpleBalance').classList.add('d-none');
    document.getElementById('smartConsumption').classList.add('d-none');
    return;
  }

  // Show loading
  document.getElementById('previewPlaceholder').classList.add('d-none');
  document.getElementById('previewLoading').classList.remove('d-none');
  document.getElementById('simpleBalance').classList.add('d-none');
  document.getElementById('smartConsumption').classList.add('d-none');

  try {
    const response = await fetch('/admin/api/preview-balance-consumption?employee_id=' + employeeId + '&leave_type_id=' + leaveTypeId + '&start_date=' + startDate + '&end_date=' + endDate);
    const data = await response.json();

    document.getElementById('previewLoading').classList.add('d-none');

    if (!data.success) {
      document.getElementById('previewPlaceholder').innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> ' + data.error + '</span>';
      document.getElementById('previewPlaceholder').classList.remove('d-none');
      document.getElementById('submitBtn').disabled = true;
      return;
    }

    if (data.totalDays === 0) {
      document.getElementById('previewPlaceholder').innerHTML = '<span class="text-warning"><i class="bi bi-info-circle"></i> No working days in selected range</span>';
      document.getElementById('previewPlaceholder').classList.remove('d-none');
      return;
    }

    // Check if simple (single type, sufficient balance) or needs smart consumption
    const primaryItem = data.breakdown[0];
    const isSingleType = data.breakdown.length === 1 && !primaryItem.isUnpaid;

    if (isSingleType) {
      // Simple mode - sufficient balance in primary type
      currentMode = 'simple';
      document.getElementById('simpleBalance').classList.remove('d-none');
      document.getElementById('smartConsumption').classList.add('d-none');
      document.getElementById('workingDays').textContent = data.totalDays + ' day' + (data.totalDays !== 1 ? 's' : '');
      document.getElementById('availableBalance').textContent = primaryItem.available.toFixed(1) + ' days';
      document.getElementById('sufficientMsg').classList.remove('d-none');
      document.getElementById('leaveForm').action = '/admin/apply-behalf';
      document.getElementById('submitBtn').disabled = false;
    } else {
      // Smart consumption mode - needs multiple types or has unpaid
      currentMode = 'smart';
      document.getElementById('simpleBalance').classList.add('d-none');
      document.getElementById('smartConsumption').classList.remove('d-none');

      // Build breakdown table
      const tableBody = document.getElementById('breakdownTable');
      tableBody.innerHTML = '';
      data.breakdown.forEach(function(item) {
        const row = document.createElement('tr');
        row.className = item.isUnpaid ? 'table-danger' : '';
        row.innerHTML = '<td>' + item.leaveTypeName + (item.isUnpaid ? ' <span class="badge bg-danger">Unpaid</span>' : '') + '</td>' +
          '<td class="text-center">' + (item.isUnpaid ? '-' : item.available.toFixed(1)) + '</td>' +
          '<td class="text-center"><strong>' + item.days + '</strong></td>';
        tableBody.appendChild(row);
      });

      // Show unpaid warning if applicable
      if (data.unpaidDays > 0) {
        document.getElementById('unpaidWarning').classList.remove('d-none');
        document.getElementById('unpaidDaysDisplay').textContent = data.unpaidDays;
      } else {
        document.getElementById('unpaidWarning').classList.add('d-none');
      }

      // Store breakdown and switch to smart route
      document.getElementById('confirmed_breakdown').value = JSON.stringify(data.breakdown);
      document.getElementById('leaveForm').action = '/admin/apply-behalf-smart';
      document.getElementById('submitBtn').disabled = true; // Require confirmation
    }

  } catch (error) {
    console.error('Preview error:', error);
    document.getElementById('previewLoading').classList.add('d-none');
    document.getElementById('previewPlaceholder').innerHTML = '<span class="text-danger">Error loading preview</span>';
    document.getElementById('previewPlaceholder').classList.remove('d-none');
  }
}

function showPlaceholder() {
  document.getElementById('previewPlaceholder').innerHTML = '<i class="bi bi-info-circle"></i> Select employee, leave type, and dates to see balance';
  document.getElementById('previewPlaceholder').classList.remove('d-none');
  document.getElementById('previewLoading').classList.add('d-none');
  document.getElementById('simpleBalance').classList.add('d-none');
  document.getElementById('smartConsumption').classList.add('d-none');
  document.getElementById('submitBtn').disabled = false;
}

function updateSubmitButton() {
  if (currentMode === 'smart') {
    document.getElementById('submitBtn').disabled = !document.getElementById('confirmSmart').checked;
  } else {
    document.getElementById('submitBtn').disabled = false;
  }
}

// Form validation
document.getElementById('leaveForm').addEventListener('submit', function(e) {
  if (currentMode === 'smart' && !document.getElementById('confirmSmart').checked) {
    e.preventDefault();
    alert('Please confirm the multi-type balance consumption before submitting.');
    return false;
  }
});
</script>
` }) %>
